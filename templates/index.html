<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>阿瓦隆在线</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="阿瓦隆(Avalon)在线游戏，经典的桌游电子版">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://storage.xxlb.org/awalong1.png">
    <link rel="apple-touch-icon" href="https://storage.xxlb.org/awalong1.png">
    <meta name="theme-color" content="#2c3e50">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3811349067654166"
			crossorigin="anonymous"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QRBM2PKEYL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QRBM2PKEYL');
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e67e22;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --good-team-color: #2980b9;
            --evil-team-color: #c0392b;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.3s;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Montserrat', Arial, sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background-color: #0a121f;
            background-image: url('https://images.unsplash.com/photo-1518709414768-a88981a4515d?q=80&w=2069&auto=format&fit=crop');
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
            position: relative;
            max-width: 100%;
            overflow-x: hidden;
            padding: 0;
            margin: 0;
        }
        
        /* 添加背景叠加层 */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(23, 32, 46, 0.85) 0%, rgba(30, 59, 95, 0.75) 50%, rgba(23, 32, 46, 0.85) 100%);
            z-index: -1;
        }
        
        /* 添加微妙的动态光效 */
        body::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/light-paper-fibers.png');
            opacity: 0.03;
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.92);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-radius: var(--border-radius);
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        /* 添加容器装饰元素 */
        .container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/subtle-white-feathers.png');
            opacity: 0.04;
            pointer-events: none;
        }

        h1, h2, h3, h4 {
            font-family: 'Cinzel', serif;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            background: linear-gradient(to right, #2c3e50, #4a6891);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        h1::after {
            content: "";
            display: block;
            width: 120px;
            height: 4px;
            background: linear-gradient(to right, #c0392b, #e67e22);
            margin: 10px auto 30px;
            border-radius: 2px;
        }
        
        h1::before {
            content: "⚔️";
            display: block;
            font-size: 1.8rem;
            margin-bottom: 10px;
            -webkit-text-fill-color: initial;
        }

        h2 {
            font-size: 1.8rem;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        h3 {
            font-size: 1.4rem;
            margin-bottom: 15px;
        }

        .hidden {
            display: none !important;
        }

        /* Button styles */
        button {
            background: linear-gradient(to bottom, var(--secondary-color), #2980b9);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 22px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed);
            margin: 5px;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        button::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transition: all 0.8s;
        }
        
        button:hover::before {
            left: 100%;
        }

        button:hover {
            background: linear-gradient(to bottom, #3aa1e0, #2980b9);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        button.success {
            background: linear-gradient(to bottom, var(--success-color), #27ae60);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        button.success:hover {
            background: linear-gradient(to bottom, #40d47e, #27ae60);
        }

        button.danger {
            background: linear-gradient(to bottom, var(--danger-color), #c0392b);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        button.danger:hover {
            background: linear-gradient(to bottom, #ff6b5b, #c0392b);
        }

        /* Form elements */
        input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            transition: border-color var(--transition-speed);
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24'%3E%3Cpath fill='%23333' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }

        label {
            font-weight: 500;
            display: block;
            margin-bottom: 8px;
            color: var(--dark-color);
        }

        /* Game setup screen */
        .setup-options {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            margin: 30px 0;
        }

        .create-game, .join-game {
            flex: 1;
            min-width: 280px;
            padding: 30px;
            border-radius: var(--border-radius);
            background-color: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
            border: 1px solid #e0e0e0;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 240px;
            justify-content: space-between;
        }
        
        .create-game::before, .join-game::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--secondary-color), var(--accent-color));
            z-index: 1;
        }
        
        /* 添加纹理效果 */
        .create-game .texture-overlay, .join-game .texture-overlay {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/subtle-white-feathers.png');
            opacity: 0.05;
            pointer-events: none;
            z-index: 0;
        }
        
        .create-game:hover, .join-game:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
        }

        .create-game h3, .join-game h3 {
            font-size: 1.4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px 0;
        }
        
        .card-footer {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        
        .create-game select, .join-game input {
            margin-top: 10px;
            transition: all 0.3s;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .create-game select:focus, .join-game input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        /* 添加图标装饰 */
        .create-game::after {
            content: "\f500";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            position: absolute;
            top: 50%;
            right: 20px;
            font-size: 80px;
            color: rgba(52, 152, 219, 0.05);
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .join-game::after {
            content: "\f2f6";
            font-family: "Font Awesome 5 Free";
            font-weight: 900;
            position: absolute;
            top: 50%;
            right: 20px;
            font-size: 80px;
            color: rgba(230, 126, 34, 0.05);
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 0;
        }

        /* Game elements */
        .quest-result {
            display: inline-block;
            width: 28px;
            height: 28px;
            margin: 0 10px;
            border-radius: 50%;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }
        
        .quest-result::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.4), inset 0 -2px 4px rgba(0, 0, 0, 0.4);
            pointer-events: none;
        }
        
        .quest-result:hover {
            transform: scale(1.2) translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .success {
            background: linear-gradient(to bottom right, #2ecc71, #27ae60);
            border: 2px solid #1c6ea4;
        }
        
        .fail {
            background: linear-gradient(to bottom right, #e74c3c, #c0392b);
            border: 2px solid #a62c2c;
        }

        .vote-track {
            display: inline-block;
            width: 18px;
            height: 18px;
            margin: 0 5px;
            border: 2px solid #444;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .vote-track.active {
            background-color: var(--danger-color);
            border-color: #a62c2c;
            transform: scale(1.1);
        }

        /* Role info section */
        .role-info {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--primary-color);
            position: relative;
            overflow: hidden;
            background-image: url('https://img.freepik.com/free-photo/grunge-marble-textured-background_53876-31148.jpg?w=740&t=st=1715107580~exp=1715108180~hmac=c5da29335a66c9af40cc9b3ebdea0d634be3d91dd980b4c0a42c0ea6b98b5bc5');
            background-size: cover;
            background-position: center;
        }
        
        .role-info::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            z-index: 0;
        }
        
        .role-info::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/parchment.png');
            opacity: 0.1;
            z-index: 0;
        }
        
        .role-info h3 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .role-info p {
            font-size: 1.1rem;
            margin: 10px 0;
            position: relative;
            z-index: 1;
        }

        /* Room info styles */
        .room-info {
            background-color: #f3f7fa;
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            text-align: center;
            border: 1px solid #d1e1ee;
            box-shadow: var(--box-shadow);
        }

        .room-info h3 {
            color: var(--secondary-color);
            margin: 0 0 15px 0;
            font-size: 1.4rem;
        }

        .room-info p {
            margin: 10px 0;
            font-size: 1.1rem;
        }

        /* Connected players */
        .connected-player {
            display: inline-block;
            padding: 6px 12px;
            margin: 5px;
            background-color: var(--success-color);
            color: white;
            border-radius: 20px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        /* Player info */
        .player-info {
            background-color: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border-left: 5px solid var(--secondary-color);
        }

        .player-info h2 {
            color: var(--secondary-color);
            font-size: 1.4rem;
            margin-bottom: 15px;
            text-align: left;
        }

        .player-info p {
            margin: 10px 0;
            font-weight: 500;
            font-size: 1.1rem;
        }

        /* Game info */
        .game-info {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            box-shadow: var(--box-shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .game-info::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://img.freepik.com/free-vector/golden-crown-royal-family-member_1284-42650.jpg');
            background-position: center;
            background-repeat: no-repeat;
            background-size: 80px;
            opacity: 0.05;
            z-index: 0;
        }

        .game-info h3 {
            color: var(--primary-color);
            font-size: 1.5rem;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        #game-id {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(to right, #f9f9f9, #f0f0f0);
            border: 2px dashed var(--accent-color);
            border-radius: var(--border-radius);
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 6px;
            color: var(--primary-color);
            margin: 20px 0;
            position: relative;
            z-index: 1;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            font-family: 'Cinzel', serif;
            text-shadow: 1px 1px 0 rgba(255, 255, 255, 0.5);
        }

        #waiting-message {
            color: #777;
            font-style: italic;
            margin-top: 15px;
            position: relative;
            z-index: 1;
        }

        /* Evil players info */
        .evil-players-info {
            margin: 25px 0;
            padding: 20px;
            border: 2px solid var(--evil-team-color);
            border-radius: var(--border-radius);
            background-color: #fef5f5;
            position: relative;
            box-shadow: var(--box-shadow);
        }

        .evil-players-info h3 {
            color: var(--evil-team-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
            text-align: left;
        }

        .evil-players-info ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .evil-players-info li {
            margin: 10px 0;
            color: #a83232;
            font-weight: 500;
            padding: 8px 15px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: var(--border-radius);
            border-left: 3px solid var(--evil-team-color);
        }

        /* Game controls */
        #team-selection, #team-vote, #quest-vote, #assassin-phase {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 25px 0;
            text-align: center;
            box-shadow: var(--box-shadow);
            animation: slideUp 0.5s;
            border: 1px solid #e0e0e0;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #team-selection h3, #team-vote h3, #quest-vote h3, #assassin-phase h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        #team-selection-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        #team-selection-buttons label {
            display: inline-flex;
            align-items: center;
            background-color: #f5f5f5;
            padding: 8px 15px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 5px;
        }

        #team-selection-buttons label:hover {
            background-color: #e9e9e9;
        }

        #team-selection-buttons input[type="checkbox"] {
            margin-right: 8px;
        }

        #team-vote button, #quest-vote button {
            padding: 12px 30px;
            font-size: 1.1rem;
            margin: 10px;
            min-width: 140px;
        }

        #team-vote button:first-child, #quest-vote button:first-child {
            background-color: var(--success-color);
        }

        #team-vote button:last-child, #quest-vote button:last-child {
            background-color: var(--danger-color);
        }

        #assassin-targets button {
            background-color: var(--danger-color);
            margin: 8px;
            transition: all 0.2s;
        }

        #assassin-targets button:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                margin-top: 15px;
                margin-bottom: 15px;
            }

            .setup-options {
                flex-direction: column;
            }

            .create-game, .join-game {
                width: 100%;
                margin-bottom: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.6rem;
            }

            .game-info, .role-info, .player-info, .room-info {
                padding: 15px;
            }

            #game-id {
                font-size: 1.5rem;
                padding: 10px 15px;
                letter-spacing: 3px;
            }

            #team-vote button, #quest-vote button {
                padding: 10px 20px;
                width: 45%;
                min-width: auto;
            }
        }
        
        /* Styled horizontal rule */
        .styled-hr {
            border: none;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0));
            margin: 20px 0;
        }
        
        /* Icon spacing in buttons */
        button i {
            margin-right: 8px;
        }
        
        /* Game status elements */
        #current-quest, #required-players, #current-leader {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* Animation for game elements appearing */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        /* Add shadows to special elements */
        #game-id, .player-info, .role-info {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Role-specific styling */
        .role-name {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            display: inline-block;
            margin: 10px 0;
        }
        
        .role-good {
            color: white;
            background: linear-gradient(to right, #2980b9, #3498db);
            border-left: 4px solid #1c6ea4;
            box-shadow: 0 2px 10px rgba(41, 128, 185, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .role-good:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(41, 128, 185, 0.3);
        }
        
        .role-evil {
            color: white;
            background: linear-gradient(to right, #c0392b, #e74c3c);
            border-left: 4px solid #a62c2c;
            box-shadow: 0 2px 10px rgba(192, 57, 43, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .role-evil:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(192, 57, 43, 0.3);
        }
        
        /* Game status section */
        .game-status {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
        }
        
        .game-status h3 {
            text-align: left;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .game-status p {
            margin: 10px 0;
            font-size: 1.05rem;
        }
        
        .game-status p i {
            width: 20px;
            text-align: center;
            margin-right: 10px;
            color: var(--accent-color);
        }

        /* Game card styling */
        .game-card {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .game-card::before {
            content: "";
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-image: url('https://www.transparenttextures.com/patterns/parchment.png');
            opacity: 0.1;
            pointer-events: none;
        }
        
        /* Footer styling */
        .footer {
            margin-top: 50px;
            padding: 25px;
            background: linear-gradient(to right, #1c2a3e, #2c3e50);
            color: white;
            text-align: center;
            border-radius: var(--border-radius);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .footer::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://www.transparenttextures.com/patterns/silver-scales.png');
            opacity: 0.07;
            pointer-events: none;
        }
        
        .footer p {
            margin: 10px 0;
        }
        
        .footer-links {
            margin-top: 15px;
        }
        
        .footer-links a {
            color: #ecf0f1;
            margin: 0 10px;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: #e67e22;
        }
        
        .footer-links i {
            margin-right: 5px;
        }

        /* 角色说明样式 */
        .role-explanation {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 25px 0;
            box-shadow: var(--box-shadow);
            border: 1px solid #e0e0e0;
        }
        
        .role-explanation h3 {
            color: var(--primary-color);
            font-size: 1.4rem;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .role-explanation h4 {
            color: var(--secondary-color);
            margin: 15px 0 10px;
            font-size: 1.2rem;
            text-align: left;
        }
        
        .role-explanation-content {
            padding: 10px;
        }
        
        .role-explanation ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .role-explanation li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .role-explanation p {
            margin: 5px 0;
            line-height: 1.5;
        }

        /* 模态框样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            padding: 35px;
            animation: modalSlideIn 0.4s;
            background-image: url('https://www.transparenttextures.com/patterns/parchment.png');
            background-size: 300px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* 添加装饰条纹给模态框和容器 */
        .container, .modal-content {
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.7)),
                url('https://www.transparenttextures.com/patterns/parchment.png');
            background-size: 300px;
        }
        
        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            color: #888;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .close-modal:hover {
            color: var(--danger-color);
        }
        
        .rules-content {
            margin-top: 20px;
            line-height: 1.6;
        }
        
        .rules-content h3 {
            margin-top: 25px;
            color: var(--primary-color);
            font-size: 1.3rem;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        
        .rules-content h4 {
            margin-top: 15px;
            font-size: 1.1rem;
            text-align: left;
        }
        
        .rules-content p, .rules-content li {
            margin-bottom: 10px;
        }
        
        .roles-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        
        .role-group {
            flex: 1;
            min-width: 280px;
            padding: 15px;
            border-radius: var(--border-radius);
        }
        
        .role-group.good {
            background-color: rgba(41, 128, 185, 0.1);
            border-left: 4px solid var(--good-team-color);
        }
        
        .role-group.evil {
            background-color: rgba(192, 57, 43, 0.1);
            border-left: 4px solid var(--evil-team-color);
        }
        
        .role-group h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .role-group.good h4 {
            color: var(--good-team-color);
        }
        
        .role-group.evil h4 {
            color: var(--evil-team-color);
        }
        
        @media (max-width: 768px) {
            .modal-content {
                padding: 20px;
                width: 95%;
            }
            
            .roles-section {
                flex-direction: column;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <h1>阿瓦隆在线</h1>
    
        <!-- 游戏创建界面 -->
        <div id="setup-screen">
            <h2>阿瓦隆在线</h2>
            <div class="setup-options">
                <div class="create-game">
                    <div class="texture-overlay"></div>
                    <h3>创建新游戏</h3>
                    <div class="card-content">
                        <label>玩家数量：
                            <select id="player-count">
                                <option value="5">5人</option>
                                <option value="6">6人</option>
                                <option value="7">7人</option>
                                <option value="8">8人</option>
                                <option value="9">9人</option>
                                <option value="10">10人</option>
                            </select>
                        </label>
                    </div>
                    <div class="card-footer">
                        <button onclick="createGame()"><i class="fas fa-plus-circle"></i> 创建游戏</button>
                    </div>
                </div>

                <div class="join-game">
                    <div class="texture-overlay"></div>
                    <h3>加入游戏</h3>
                    <div class="card-content">
                        <input type="text" id="game-id-input" placeholder="输入游戏ID">
                    </div>
                    <div class="card-footer">
                        <button id="join-button" onclick="joinExistingGame()"><i class="fas fa-sign-in-alt"></i> 加入游戏</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 角色选择界面 -->
        <div id="role-screen" class="hidden">
            <h2>等待游戏开始</h2>
            <div class="room-info">
                <h3><i class="fas fa-users"></i> 房间信息</h3>
                <p><i class="fas fa-user-friends"></i> 房间人数: <span id="player-count-display"></span> 人</p>
                <p><i class="fas fa-user-check"></i> 已加入玩家: <span id="connected-players"></span></p>
                <p><i class="fas fa-id-badge"></i> 你的编号: <span id="your-player-number"></span></p>
                <button id="start-game-btn" onclick="startGame()" class="success"><i class="fas fa-play"></i> 开始游戏</button>
                <p id="min-players-msg" class="hidden" style="color: #e74c3c; margin-top: 10px;"><i class="fas fa-exclamation-circle"></i> 至少需要5名玩家才能开始游戏</p>
            </div>
            <div id="role-info" class="role-info hidden">
                <h3><i class="fas fa-chess-knight"></i> 你的角色信息</h3>
                <p id="role-name"></p>
                <p id="role-special-info"></p>
            </div>
            <div class="role-explanation">
                <h3><i class="fas fa-book"></i> 角色说明</h3>
                <div class="role-explanation-content">
                    <h4>正义方</h4>
                    <ul>
                        <li><strong>梅林：</strong>知道所有邪恶方（除莫德雷德外）的身份，但不能透露自己的身份，否则会被刺客刺杀。</li>
                        <li><strong>派西维尔：</strong>知道谁是梅林，但无法区分梅林和莫甘娜。</li>
                        <li><strong>忠臣：</strong>不知道任何玩家的身份，忠于亚瑟王。</li>
                    </ul>
                    <h4>邪恶方</h4>
                    <ul>
                        <li><strong>莫德雷德：</strong>邪恶方首领，不被梅林看到，知道其他邪恶方身份。</li>
                        <li><strong>莫甘娜：</strong>会干扰派西维尔的能力，知道其他邪恶方身份。</li>
                        <li><strong>刺客：</strong>游戏结束时有机会刺杀梅林，知道其他邪恶方身份。</li>
                        <li><strong>奥伯伦：</strong>独行侠，不被其他邪恶方认出，也不知道其他邪恶方身份。</li>
                        <li><strong>爪牙：</strong>服务于邪恶首领，知道其他邪恶方身份。</li>
                    </ul>
                    <h4>游戏配置</h4>
                    <p>5人局：梅林、派西维尔、忠臣、莫甘娜、刺客</p>
                    <p>6人局：梅林、派西维尔、忠臣×2、莫甘娜、刺客</p>
                    <p>7人局：梅林、派西维尔、忠臣×2、莫甘娜、刺客、奥伯伦</p>
                    <p>8人局：梅林、派西维尔、忠臣×3、莫甘娜、刺客、爪牙</p>
                    <p>9人局：梅林、派西维尔、忠臣×4、莫甘娜、刺客、莫德雷德</p>
                    <p>10人局：梅林、派西维尔、忠臣×4、莫甘娜、刺客、莫德雷德、奥伯伦</p>
                </div>
            </div>
        </div>

        <!-- 游戏主界面 -->
        <div id="game-screen" class="hidden">
            <h2>游戏进行中</h2>
            <div id="game-info" class="game-card">
                <div class="player-info">
                    <h3><i class="fas fa-user-circle"></i> 玩家信息</h3>
                    <p><i class="fas fa-hashtag"></i> 你的编号：玩家<span id="game-player-number"></span></p>
                    <p><i class="fas fa-mask"></i> 你的角色：<span id="game-player-role"></span></p>
                </div>
                <hr class="styled-hr">
                <div class="game-status">
                    <h3><i class="fas fa-chess-board"></i> 游戏状态</h3>
                    <p><i class="fas fa-tasks"></i> 当前任务：<span id="current-quest"></span></p>
                    <p><i class="fas fa-history"></i> 任务结果：<span id="quest-results"></span></p>
                    <p><i class="fas fa-users"></i> 需要人数：<span id="required-players"></span></p>
                    <p><i class="fas fa-crown"></i> 当前队长：玩家<span id="current-leader"></span></p>
                    <p><i class="fas fa-vote-yea"></i> 投票追踪：<span id="vote-track"></span></p>
                </div>
            </div>

            <div id="team-selection" class="hidden">
                <h3>选择队员</h3>
                <div id="team-selection-buttons"></div>
                <button onclick="submitTeam()"><i class="fas fa-check-circle"></i> 确认选择</button>
            </div>

            <div id="team-vote" class="hidden">
                <h3>队伍投票</h3>
                <button class="success" onclick="submitTeamVote(true)"><i class="fas fa-thumbs-up"></i> 同意</button>
                <button class="danger" onclick="submitTeamVote(false)"><i class="fas fa-thumbs-down"></i> 反对</button>
            </div>

            <div id="quest-vote" class="hidden">
                <h3>任务投票</h3>
                <button class="success" onclick="submitQuestVote(true)"><i class="fas fa-check"></i> 成功</button>
                <button class="danger" onclick="submitQuestVote(false)"><i class="fas fa-times"></i> 失败</button>
            </div>

            <div id="assassin-phase" class="hidden">
                <h3>刺客阶段</h3>
                <p>请选择要刺杀的目标：</p>
                <div id="assassin-targets"></div>
            </div>
        </div>

        <!-- 游戏ID显示区域 -->
        <div class="game-info" style="display: none;">
            <h3><i class="fas fa-gamepad"></i> 游戏ID: <span id="game-id"></span></h3>
            <p id="waiting-message"><i class="fas fa-hourglass-half"></i> 等待其他玩家加入...</p>
        </div>

        <!-- 玩家角色信息 - 初始隐藏 -->
        <div class="player-info hidden">
            <h2>你的角色信息</h2>
            <p id="player-name"></p>
            <p id="player-role"></p>
            <p id="player-camp"></p>
        </div>

        <!-- 添加邪恶方信息显示区域 - 初始隐藏 -->
        <div class="evil-players-info hidden">
            <h3 id="evil-info-title"></h3>
            <ul id="evil-players-list"></ul>
        </div>

        <!-- Footer section -->
        <footer class="footer">
            <p>阿瓦隆在线 © 2025 | 谎言与信任的较量，智慧与勇气的战场！</p>
            <p class="footer-links">
                <a href="#" id="rules-link"><i class="fas fa-book"></i> 游戏规则</a>
                <a href="mailto:657091728@qq.com"><i class="fas fa-envelope"></i> 联系我们</a>
            </p>
        </footer>
    </div>

    <!-- 游戏规则模态框 -->
    <div id="rules-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2><i class="fas fa-book"></i> 阿瓦隆游戏规则</h2>
            <div class="rules-content">
                <h3>游戏概述</h3>
                <p>《阿瓦隆》是一款社交推理游戏，玩家分为正义方和邪恶方两个阵营。正义方需要成功完成三个任务，而邪恶方则试图阻止他们。所有玩家的身份对其他人保密，只有特定角色能获得有限的信息。</p>
                
                <h3>游戏流程</h3>
                <ol>
                    <li><strong>角色分配：</strong>每位玩家随机获得一个角色，属于正义方或邪恶方。</li>
                    <li><strong>队长选择：</strong>每轮任务由一位队长选择执行任务的团队成员。</li>
                    <li><strong>团队投票：</strong>所有玩家投票决定是否同意这个团队执行任务。如果大多数同意，则进入任务阶段；否则，下一位玩家成为队长并重新选择团队。</li>
                    <li><strong>任务执行：</strong>被选中的团队成员秘密投票决定任务的成功或失败。正义方只能投成功票，而邪恶方可以投成功或失败票。</li>
                    <li><strong>胜利条件：</strong>正义方需要成功完成三个任务；邪恶方需要使三个任务失败，或者在五次连续投票都被拒绝后获胜。</li>
                    <li><strong>刺客阶段：</strong>如果正义方获得三次任务成功，刺客有一次机会猜测谁是梅林。如果猜对，邪恶方获胜；否则，正义方获胜。</li>
                </ol>
                
                <h3>角色说明</h3>
                <div class="roles-section">
                    <div class="role-group good">
                        <h4>正义方角色</h4>
                        <ul>
                            <li><strong>梅林：</strong>知道所有邪恶方成员（除莫德雷德外），但不能明显表现出来，否则会被刺杀。</li>
                            <li><strong>派西维尔：</strong>知道谁是梅林，但无法区分梅林和莫甘娜。</li>
                            <li><strong>忠臣：</strong>不知道其他玩家的身份，忠于亚瑟王。</li>
                        </ul>
                    </div>
                    
                    <div class="role-group evil">
                        <h4>邪恶方角色</h4>
                        <ul>
                            <li><strong>莫德雷德：</strong>不被梅林看到，知道其他邪恶方成员。</li>
                            <li><strong>莫甘娜：</strong>会迷惑派西维尔，知道其他邪恶方成员。</li>
                            <li><strong>刺客：</strong>负责在游戏结束时刺杀梅林，知道其他邪恶方成员。</li>
                            <li><strong>奥伯伦：</strong>邪恶方成员，但不知道其他邪恶方是谁，其他邪恶方也不知道他。</li>
                            <li><strong>爪牙：</strong>普通邪恶方成员，知道其他邪恶方成员。</li>
                        </ul>
                    </div>
                </div>
                
                <h3>游戏技巧</h3>
                <ul>
                    <li>作为梅林，要小心隐藏自己的身份，不要太明显地指出邪恶方成员。</li>
                    <li>作为邪恶方，有时故意投成功票可以隐藏自己的身份。</li>
                    <li>观察投票模式和行为，这往往能揭示玩家的真实身份。</li>
                    <li>在选择团队时，要考虑过去的任务结果和玩家的行为。</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        var socket = io();
        var playerName = '';
        var playerRole = '';
        var playerCamp = '';
        var myPlayerId = '';
        var gameId = '';
        var currentRoom = '';
        
        // 清除之前的事件监听器
        socket.off('connect');
        socket.off('role_info');
        socket.off('join_room');

        // 加入房间时显示游戏ID
        socket.on('join_room', function(room) {
            console.log('Joined game:', room);
            gameId = room;
            
            // 显示游戏ID和等待消息
            const gameInfoDiv = document.querySelector('.game-info');
            const gameIdSpan = document.getElementById('game-id');
            
            if (gameIdSpan && gameInfoDiv) {
                gameIdSpan.textContent = gameId;
                gameInfoDiv.style.display = 'block';
                addFadeInAnimation(gameInfoDiv);
            }
        });

        // 当游戏开始时，切换到游戏界面
        socket.on('game_started', function(data) {
            console.log('Game started event received:', data);
            
            // 隐藏等待消息
            const waitingMessage = document.getElementById('waiting-message');
            if (waitingMessage) {
                waitingMessage.style.display = 'none';
            }
            
            // 隐藏角色等待界面，显示游戏主界面
            document.getElementById('role-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            // 显示队长信息
            const leaderInfo = document.createElement('div');
            leaderInfo.className = 'alert-message';
            leaderInfo.innerHTML = `<i class="fas fa-crown"></i> 游戏已开始！玩家${data.leader}是第一位队长`;
            leaderInfo.style.position = 'fixed';
            leaderInfo.style.top = '20px';
            leaderInfo.style.left = '50%';
            leaderInfo.style.transform = 'translateX(-50%)';
            leaderInfo.style.backgroundColor = 'rgba(52, 152, 219, 0.9)';
            leaderInfo.style.color = 'white';
            leaderInfo.style.padding = '15px 25px';
            leaderInfo.style.borderRadius = '5px';
            leaderInfo.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            leaderInfo.style.zIndex = '9999';
            leaderInfo.style.maxWidth = '80%';
            leaderInfo.style.textAlign = 'center';
            leaderInfo.style.fontWeight = 'bold';
            document.body.appendChild(leaderInfo);
            
            // 3秒后自动关闭
            setTimeout(() => {
                leaderInfo.style.animation = 'fadeOut 0.3s forwards';
                setTimeout(() => {
                    if (leaderInfo.parentNode) {
                        leaderInfo.parentNode.removeChild(leaderInfo);
                    }
                }, 300);
            }, 5000);
            
            // 如果当前玩家是队长，显示队员选择界面
            if (myPlayerId == data.leader) {
                document.getElementById('team-selection').classList.remove('hidden');
                
                // 生成队员选择按钮
                const teamSelectionButtons = document.getElementById('team-selection-buttons');
                teamSelectionButtons.innerHTML = '';
                for (let i = 1; i <= data.player_count; i++) {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = i;
                    
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(`玩家${i}`));
                    teamSelectionButtons.appendChild(label);
                }
            }
        });

        // 添加淡入动画的辅助函数
        function addFadeInAnimation(element) {
            element.classList.add('fade-in');
            // 动画结束后移除类
            setTimeout(() => {
                element.classList.remove('fade-in');
            }, 500);
        }

        // 在连接时保存玩家ID
        socket.on('connect', function() {
            console.log('Connected to server');
            // 不再在这里设置myPlayerId，等待服务器分配
            console.log('Socket connected with ID:', socket.id);
            
            // 初始化开始游戏按钮
            setTimeout(updateStartGameButton, 500);
        });

        // 监听错误事件
        socket.on('error', function(data) {
            console.error('Received error:', data);
            
            // 清除任何超时处理器
            if (window.joinTimeoutId) {
                console.log('Clearing join timeout on error');
                clearTimeout(window.joinTimeoutId);
                window.joinTimeoutId = null;
            }
            
            // 重置按钮状态
            const joinButton = document.getElementById('join-button');
            if (joinButton.disabled) {
                joinButton.disabled = false;
                joinButton.textContent = '加入游戏';
            }
            
            // 显示错误消息
            showErrorMessage(data.message || '发生未知错误');
            
            // 对于特定错误，清空游戏ID输入
            const gameIdErrors = ['游戏ID不存在', '游戏已经开始', '游戏房间已满'];
            if (data.message && gameIdErrors.includes(data.message)) {
                document.getElementById('game-id-input').value = '';
            }
        });

        socket.on('game_created', (data) => {
            console.log('Game created:', data);
            const gameId = data.game_id;
            
            // 保存游戏ID到全局变量
            window.gameId = gameId;
            
            // 显示游戏ID
            const gameInfoDiv = document.querySelector('.game-info');
            const gameIdSpan = document.getElementById('game-id');
            
            if (gameIdSpan && gameInfoDiv) {
                gameIdSpan.textContent = gameId;
                gameInfoDiv.style.display = 'block';
            }

            // 更新玩家状态
            if (data.player_id !== undefined) {
                myPlayerId = data.player_id;
                
                // 设置玩家编号显示
                document.getElementById('your-player-number').textContent = myPlayerId;
                
                // 隐藏设置界面，显示角色界面
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('role-screen').classList.remove('hidden');
                
                // 设置房间人数显示
                document.getElementById('player-count-display').textContent = data.player_count;
                
                // 更新已连接玩家显示
                if (data.connected_players) {
                    updateConnectedPlayers(data.connected_players);
                }
                
                console.log('Switched to role screen after creating game');
            }
        });

        // 更新角色信息的处理
        socket.on('role_info', (data) => {
            console.log('Role info received:', data);
            document.getElementById('role-info').classList.remove('hidden');
            
            // 显示角色信息
            playerRole = data.role;
            playerCamp = data.camp;
            
            // 更新角色信息显示
            const roleName = document.getElementById('role-name');
            roleName.innerHTML = `<span class="role-name role-${data.camp === '正义方' ? 'good' : 'evil'}">
                <i class="fas fa-${data.camp === '正义方' ? 'shield-alt' : 'skull'}"></i> 
                角色: ${data.role} (${data.camp})
            </span>`;
            
            // 显示特殊信息（例如梅林可以看到的邪恶方）
            const roleSpecialInfo = document.getElementById('role-special-info');
            if (data.evil_players) {
                let specialInfo = '你可以看到的邪恶方玩家：<ul>';
                for (let i = 0; i < data.evil_players.length; i++) {
                    const evilPlayer = data.evil_players[i];
                    const evilRole = data.evil_roles ? data.evil_roles[i] : '未知';
                    specialInfo += `<li>玩家${evilPlayer} - ${evilRole}</li>`;
                }
                specialInfo += '</ul>';
                roleSpecialInfo.innerHTML = specialInfo;
                
                // 也更新页面上的邪恶方信息显示
                const evilInfoTitle = document.getElementById('evil-info-title');
                const evilPlayersList = document.getElementById('evil-players-list');
                const evilPlayersInfo = document.querySelector('.evil-players-info');
                
                if (evilInfoTitle && evilPlayersList && evilPlayersInfo) {
                    evilInfoTitle.textContent = data.role === '梅林' ? 
                        '梅林看到的邪恶方玩家' : '你的邪恶同伴';
                    
                    evilPlayersList.innerHTML = '';
                    for (let i = 0; i < data.evil_players.length; i++) {
                        if (data.evil_players[i] !== myPlayerId) {  // 不显示自己
                            const li = document.createElement('li');
                            li.innerHTML = `玩家${data.evil_players[i]} - ${data.evil_roles ? data.evil_roles[i] : '未知'}`;
                            evilPlayersList.appendChild(li);
                        }
                    }
                    
                    // 使用classList切换hidden类
                    evilPlayersInfo.classList.remove('hidden');
                    addFadeInAnimation(evilPlayersInfo);
                }
            } else if (data.merlin_morgana) {
                // 派西维尔特殊信息
                let specialInfo = '你看到的梅林和莫甘娜（无法区分）：<ul>';
                for (let i = 0; i < data.merlin_morgana.length; i++) {
                    const player = data.merlin_morgana[i];
                    specialInfo += `<li>玩家${player} - 梅林或莫甘娜</li>`;
                }
                specialInfo += '</ul>';
                roleSpecialInfo.innerHTML = specialInfo;
                
                // 也更新页面上的特殊信息显示
                const evilInfoTitle = document.getElementById('evil-info-title');
                const evilPlayersList = document.getElementById('evil-players-list');
                const evilPlayersInfo = document.querySelector('.evil-players-info');
                
                if (evilInfoTitle && evilPlayersList && evilPlayersInfo) {
                    evilInfoTitle.textContent = '派西维尔看到的梅林和莫甘娜';
                    
                    evilPlayersList.innerHTML = '';
                    for (let i = 0; i < data.merlin_morgana.length; i++) {
                        const li = document.createElement('li');
                        li.innerHTML = `玩家${data.merlin_morgana[i]} - 梅林或莫甘娜`;
                        evilPlayersList.appendChild(li);
                    }
                    
                    // 使用classList切换hidden类
                    evilPlayersInfo.classList.remove('hidden');
                    addFadeInAnimation(evilPlayersInfo);
                }
            } else {
                roleSpecialInfo.textContent = '没有特殊信息。';
            }
        });

        socket.on('game_state', (data) => {
            console.log('Game state:', data);
            
            // 当收到游戏状态时，确保切换到游戏界面
            document.getElementById('role-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            
            document.getElementById('game-player-number').textContent = myPlayerId;
            document.getElementById('game-player-role').textContent = playerRole;
            document.getElementById('current-quest').textContent = data.current_quest;
            document.getElementById('required-players').textContent = data.required_players;
            document.getElementById('current-leader').textContent = data.leader;
            
            // 更新任务结果显示
            const questResultsContainer = document.getElementById('quest-results');
            questResultsContainer.innerHTML = '';
            data.quest_results.forEach(result => {
                const span = document.createElement('span');
                span.className = `quest-result ${result === '成功' ? 'success' : 'fail'}`;
                span.title = result;
                questResultsContainer.appendChild(span);
                // 添加淡入动画
                addFadeInAnimation(span);
            });
            
            // 更新投票追踪显示
            const voteTrackContainer = document.getElementById('vote-track');
            voteTrackContainer.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const span = document.createElement('span');
                span.className = `vote-track ${i < data.vote_track ? 'active' : ''}`;
                voteTrackContainer.appendChild(span);
                // 为新激活的投票追踪添加动画
                if (i < data.vote_track) {
                    addFadeInAnimation(span);
                }
            }
            
            // 隐藏选择队员的UI，除非当前玩家是队长
            const isLeader = myPlayerId == data.leader;
            document.getElementById('team-selection').className = isLeader ? '' : 'hidden';
            
            // 生成队员选择按钮
            if (isLeader) {
                const teamSelectionButtons = document.getElementById('team-selection-buttons');
                teamSelectionButtons.innerHTML = '';
                for (let i = 1; i <= data.player_count; i++) {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = i;
                    
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(`玩家${i}`));
                    teamSelectionButtons.appendChild(label);
                }
                addFadeInAnimation(document.getElementById('team-selection'));
            }
        });

        socket.on('team_proposed', (data) => {
            document.getElementById('team-selection').classList.add('hidden');
            document.getElementById('team-vote').classList.remove('hidden');
            // 清除之前的队员信息
            const oldTeamInfo = document.querySelector('#team-vote p');
            if (oldTeamInfo) {
                oldTeamInfo.remove();
            }
            // 显示被提名的队员
            const selectedTeam = data.team.map(id => `玩家${id}`).join(', ');
            document.getElementById('team-vote').insertAdjacentHTML('afterbegin', 
                `<p>提名队员：${selectedTeam}</p>`);
        });

        socket.on('team_vote_result', (data) => {
            console.log('收到团队投票结果:', data);
            try {
                document.getElementById('team-vote').classList.add('hidden');
                
                // 显示投票结果
                const voteResults = Object.entries(data.votes)
                    .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))  // 按玩家编号排序
                    .map(([pid, vote]) => `玩家${parseInt(pid)+1}: ${vote ? '同意' : '反对'}`)
                    .join(', ');
                
                console.log('投票结果字符串:', voteResults);
                alert(`投票结果：${voteResults}`);
                
                if (data.success) {
                    // 详细记录调试信息
                    console.log("当前玩家ID(原始值):", myPlayerId, "类型:", typeof myPlayerId);
                    const playerIdNumber = parseInt(myPlayerId);
                    console.log("当前玩家ID(转换后):", playerIdNumber, "类型:", typeof playerIdNumber);
                    console.log("任务队员:", data.team, "类型:", typeof data.team[0]);
                    
                    // 直接比较数字，不使用includes
                    let isInTeam = false;
                    for (let i = 0; i < data.team.length; i++) {
                        console.log(`比较: ${playerIdNumber} vs ${data.team[i]}`);
                        if (playerIdNumber === data.team[i]) {
                            isInTeam = true;
                            break;
                        }
                    }
                    
                    console.log("玩家是否在团队中:", isInTeam);
                    
                    if (isInTeam) {
                        console.log("显示任务投票按钮");
                        document.getElementById('quest-vote').classList.remove('hidden');
                    } else {
                        console.log("玩家不在任务队员中，不显示投票按钮");
                    }
                    
                    // 显示被选中的队员
                    const questInfo = document.createElement('p');
                    questInfo.textContent = `执行任务的队员：${data.team.map(id => `玩家${id}`).join(', ')}`;
                    document.getElementById('game-info').appendChild(questInfo);
                    // 清除之前的队员信息
                    const oldTeamInfo = document.querySelector('#team-vote p');
                    if (oldTeamInfo) {
                        oldTeamInfo.remove();
                    }
                }
            } catch (error) {
                console.error('处理投票结果时出错:', error);
            }
        });

        socket.on('quest_vote_result', (data) => {
            document.getElementById('quest-vote').classList.add('hidden');
            // 移除之前显示的队员信息
            const questInfo = document.getElementById('game-info').lastElementChild;
            if (questInfo && questInfo.textContent.includes('执行任务的队员')) {
                questInfo.remove();
            }
            // 显示任务投票结果
            const voteCount = data.vote_count;
            alert(`任务结果：成功${voteCount.success}票，失败${voteCount.fail}票`);
            
            if (data.game_over && playerRole === '刺客') {
                document.getElementById('assassin-phase').classList.remove('hidden');
                // 创建刺杀目标选择按钮
                const assassinTargets = document.getElementById('assassin-targets');
                assassinTargets.innerHTML = '';
                for (let i = 1; i <= parseInt(document.getElementById('player-count-display').textContent); i++) {
                    if (i !== myPlayerId) {  // 不能刺杀自己
                        const button = document.createElement('button');
                        button.textContent = `刺杀玩家${i}`;
                        button.onclick = () => {
                            if (confirm(`确定要刺杀玩家${i}吗？`)) {
                                assassinate(i);
                                document.getElementById('assassin-phase').classList.add('hidden');
                            }
                        };
                        assassinTargets.appendChild(button);
                    }
                }
            }
            if (data.game_over) {
                alert(data.message);
            }
        });

        socket.on('assassination_result', (data) => {
            alert(data.message);
            // 可以添加重新开始游戏的选项
        });

        socket.on('game_validated', (data) => {
            console.log('Game validated response:', data);
            
            if (data.valid) {
                // 保存游戏ID到全局变量（从验证请求中获取）
                const gameIdInput = document.getElementById('game-id-input');
                const validatedGameId = gameIdInput.value.trim();
                window.gameId = validatedGameId;
                console.log(`游戏验证成功，设置window.gameId = ${validatedGameId}`);
                
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('role-screen').classList.remove('hidden');
                
                // 显示房间人数
                document.getElementById('player-count-display').textContent = data.player_count;
                
                // 显示已连接的玩家
                updateConnectedPlayers(data.connected_players || []);
            }
        });

        // 添加玩家加入事件处理
        socket.on('player_joined', (data) => {
            console.log('Player joined event received:', data);
            
            // 如果是当前玩家加入，保存玩家ID
            if (myPlayerId === null) {
                myPlayerId = data.player_id;
                console.log(`Setting my player ID to ${myPlayerId}`);
                document.getElementById('your-player-number').textContent = data.player_id;
            }
            
            // 更新已连接玩家显示
            updateConnectedPlayers(data.connected_players);
            console.log(`Updated connected players: ${data.connected_players}`);
            
            // 更新房间人数显示
            if (data.player_count !== undefined) {
                console.log(`Updating room player count to ${data.player_count}`);
                document.getElementById('player-count-display').textContent = data.player_count;
            } else if (data.connected_players) {
                // 如果没有提供player_count，则使用连接玩家数量
                const count = data.connected_players.length;
                console.log(`Setting room player count based on connected players: ${count}`);
                document.getElementById('player-count-display').textContent = count;
            }
            
            // 更新开始游戏按钮状态
            updateStartGameButton();
            
            // 只有当所有玩家都加入后才开始游戏
            if (data.all_players_joined) {
                console.log('All players joined, switching to game screen');
                document.getElementById('role-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
            }
        });

        // 添加玩家离开事件处理
        socket.on('player_left', (data) => {
            updateConnectedPlayers(data.connected_players);
        });

        // 更新已连接玩家显示
        function updateConnectedPlayers(players) {
            const container = document.getElementById('connected-players');
            container.innerHTML = '';
            
            // 显示已连接玩家 - 无需增加+1
            players.sort((a, b) => a - b).forEach(pid => {
                const span = document.createElement('span');
                span.className = 'connected-player';
                span.textContent = `玩家${pid}`;
                container.appendChild(span);
            });
            
            // 更新开始游戏按钮状态
            updateStartGameButton();
        }

        // 用户操作函数
        function createGame() {
            console.log("Creating new game...");
            socket.emit('create_game');
        }

        function submitTeam() {
            const checkboxes = document.querySelectorAll('#team-selection-buttons input:checked');
            const requiredPlayers = parseInt(document.getElementById('required-players').textContent);
            
            if (checkboxes.length !== requiredPlayers) {
                alert(`请选择${requiredPlayers}名队员`);
                return;
            }
            
            // 使用正确的gameId变量（从window对象中获取，或使用全局变量）
            const currentGameId = window.gameId || gameId;
            
            const team = Array.from(checkboxes).map(cb => parseInt(cb.value));
            console.log(`提交队伍: ${team.join(', ')} 到游戏 ${currentGameId}`);
            socket.emit('propose_team', { game_id: currentGameId, team: team });
        }

        function submitTeamVote(approve) {
            // 使用正确的gameId变量
            const currentGameId = window.gameId || gameId;
            console.log(`正在提交团队投票, window.gameId = ${window.gameId}, gameId = ${gameId}, 使用: ${currentGameId}`);
            
            // 确保玩家ID是整数
            const playerId = parseInt(myPlayerId);
            console.log(`提交团队投票: ${approve ? '同意' : '反对'}, 玩家ID: ${playerId}`);
            
            socket.emit('team_vote', {
                game_id: currentGameId,
                player_id: playerId,
                vote: approve
            });
            document.getElementById('team-vote').classList.add('hidden');
        }

        function submitQuestVote(success) {
            // 使用正确的gameId变量
            const currentGameId = window.gameId || gameId;
            
            // 确保玩家ID是整数
            const playerId = parseInt(myPlayerId);
            console.log(`提交任务投票: 玩家ID=${playerId}, 投票=${success ? '成功' : '失败'}`);
            console.log(`原始myPlayerId=${myPlayerId}, 类型=${typeof myPlayerId}`);
            
            socket.emit('quest_vote', {
                game_id: currentGameId,
                player_id: playerId,
                vote: success
            });
            // 隐藏投票按钮，防止重复投票
            document.getElementById('quest-vote').classList.add('hidden');
        }

        function assassinate(target) {
            // 使用正确的gameId变量
            const currentGameId = window.gameId || gameId;
            
            // 确保目标ID是整数
            const targetId = parseInt(target);
            console.log(`执行刺杀: 目标玩家${targetId}`);
            
            socket.emit('assassinate', {
                game_id: currentGameId,
                target: targetId
            });
        }

        function joinExistingGame() {
            const gameIdInput = document.getElementById('game-id-input');
            const gameId = gameIdInput.value.trim();
            const joinButton = document.getElementById('join-button');
            
            // 清空任何存在的错误消息
            clearErrorMessages();
            
            if (!gameId) {
                showErrorMessage('游戏ID不能为空');
                return;
            }
            
            // 禁用按钮，显示加载状态
            joinButton.disabled = true;
            joinButton.textContent = '加入中...';
            
            // 清除任何现有的超时处理器
            if (window.joinTimeoutId) {
                console.log('Clearing existing timeout', window.joinTimeoutId);
                clearTimeout(window.joinTimeoutId);
            }
            
            // 设置超时处理 - 增加至20秒
            window.joinTimeoutId = setTimeout(() => {
                console.log('Join game timeout triggered after 20 seconds');
                // 重置按钮状态
                joinButton.disabled = false;
                joinButton.textContent = '加入游戏';
                // 显示超时错误信息
                showErrorMessage('加入游戏超时，请检查网络连接并重试。如果问题持续存在，请尝试刷新页面。');
                // 清除超时ID
                window.joinTimeoutId = null;
            }, 20000); // 20秒超时
            
            console.log(`Attempting to join game with ID: ${gameId}`);
            
            // 直接发送加入游戏请求
            socket.emit('join_game', { game_id: gameId });
            console.log(`Sent join_game request for game: ${gameId}`);
        }

        function copyGameId(id) {
            navigator.clipboard.writeText(id).then(() => {
                const copyButton = document.querySelector('.copy-button');
                const originalText = copyButton.textContent;
                copyButton.textContent = '已复制！';
                setTimeout(() => {
                    copyButton.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制游戏ID');
            });
        }

        // 监听加入游戏成功事件
        socket.on('joined_game', function(data) {
            console.log('Joined game successfully:', data);
            const gameId = data.game_id;
            const playerId = data.player_id;
            
            // 保存游戏ID到全局变量
            window.gameId = gameId;
            console.log(`设置window.gameId = ${gameId}`);
            
            // 清除任何超时处理器
            if (window.joinTimeoutId) {
                console.log('Clearing join timeout on successful join');
                clearTimeout(window.joinTimeoutId);
                window.joinTimeoutId = null;
            }
            
            // 重置按钮状态
            const joinButton = document.getElementById('join-button');
            joinButton.disabled = false;
            joinButton.textContent = '加入游戏';
            
            // 隐藏设置界面，显示角色界面
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('role-screen').classList.remove('hidden');
            
            // 显示游戏ID
            const gameInfoDiv = document.querySelector('.game-info');
            const gameIdSpan = document.getElementById('game-id');
            
            if (gameIdSpan && gameInfoDiv) {
                gameIdSpan.textContent = gameId;
                gameInfoDiv.style.display = 'block';
                addFadeInAnimation(gameInfoDiv);
            }
            
            // 显示玩家编号
            if (playerId !== undefined) {
                console.log(`玩家ID已设置: ${playerId}`);
                document.getElementById('your-player-number').textContent = playerId;
                myPlayerId = playerId;
            }
        });

        // 显示错误消息的函数
        function showErrorMessage(message) {
            // 创建错误消息元素
            const errorMsg = document.createElement('div');
            errorMsg.className = 'error-message';
            errorMsg.textContent = message;
            errorMsg.style.backgroundColor = 'rgba(231, 76, 60, 0.9)';
            errorMsg.style.color = 'white';
            errorMsg.style.padding = '10px 20px';
            errorMsg.style.borderRadius = '5px';
            errorMsg.style.marginTop = '10px';
            errorMsg.style.fontWeight = 'bold';
            errorMsg.style.textAlign = 'center';
            errorMsg.style.animation = 'fadeIn 0.3s';
            
            // 添加到适当的容器
            const container = document.querySelector('.container');
            // 检查是否已有错误消息
            const existingError = document.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            container.insertBefore(errorMsg, container.firstChild);
            
            // 自动关闭
            setTimeout(() => {
                errorMsg.style.animation = 'fadeOut 0.3s forwards';
                setTimeout(() => {
                    if (errorMsg.parentNode) {
                        errorMsg.parentNode.removeChild(errorMsg);
                    }
                }, 300);
            }, 5000);
        }
        
        // 清除错误消息
        function clearErrorMessages() {
            const errorMsgs = document.querySelectorAll('.error-message');
            errorMsgs.forEach(msg => {
                msg.style.animation = 'fadeOut 0.3s forwards';
                setTimeout(() => {
                    if (msg.parentNode) {
                        msg.parentNode.removeChild(msg);
                    }
                }, 300);
            });
        }

        // 更新开始游戏按钮状态
        function updateStartGameButton() {
            const connectedPlayers = document.querySelectorAll('.connected-player');
            const startButton = document.getElementById('start-game-btn');
            const minPlayersMsg = document.getElementById('min-players-msg');
            
            if (connectedPlayers.length < 5) {
                startButton.disabled = true;
                startButton.classList.add('disabled');
                minPlayersMsg.classList.remove('hidden');
            } else {
                startButton.disabled = false;
                startButton.classList.remove('disabled');
                minPlayersMsg.classList.add('hidden');
            }
        }

        // 开始游戏
        function startGame() {
            console.log("Starting game...");
            const currentGameId = window.gameId || gameId;
            socket.emit('start_game_manual', { game_id: currentGameId });
        }
        
        // 确保window加载完成后初始化操作
        window.onload = function() {
            // 初始化UI组件
            updateStartGameButton();
            
            // 初始化游戏规则模态框
            initRulesModal();
        };
        
        // 游戏规则模态框控制
        function initRulesModal() {
            const rulesLink = document.getElementById('rules-link');
            const rulesModal = document.getElementById('rules-modal');
            const closeModal = document.querySelector('.close-modal');
            
            // 点击游戏规则链接打开模态框
            rulesLink.addEventListener('click', function(e) {
                e.preventDefault();
                rulesModal.classList.add('show');
                document.body.style.overflow = 'hidden'; // 防止背景滚动
            });
            
            // 点击关闭按钮关闭模态框
            closeModal.addEventListener('click', function() {
                rulesModal.classList.remove('show');
                document.body.style.overflow = ''; // 恢复背景滚动
            });
            
            // 点击模态框背景关闭模态框
            rulesModal.addEventListener('click', function(e) {
                if (e.target === rulesModal) {
                    rulesModal.classList.remove('show');
                    document.body.style.overflow = '';
                }
            });
            
            // 按ESC键关闭模态框
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && rulesModal.classList.contains('show')) {
                    rulesModal.classList.remove('show');
                    document.body.style.overflow = '';
                }
            });
        }
    </script>
</body>
</html>